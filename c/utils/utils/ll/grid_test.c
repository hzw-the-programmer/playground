#include <string.h>
#include <assert.h>
#include "grid.h"
#include "../utils.h"

void grid_layout_test_helper(grid_t *grid, const rect_t *rect, const rect_t *wanted) {
    int i;

    grid_measure(grid, rect, 0, 0);
    grid_layout(grid, rect);
    
    for (i = 0; i < GRID_PAGE_CAP(grid); i++) {
        assert(grid->rects[i].x == wanted[i].x);
        assert(grid->rects[i].y == wanted[i].y);
        assert(grid->rects[i].w == wanted[i].w);
        assert(grid->rects[i].h == wanted[i].h);
    }
}

typedef struct {
    int len;
} grid_test_ctx_t;

int grid_test_ctx_len(void *data) {
    grid_test_ctx_t *ctx = data;
    return ctx->len;
}

void grid_nav_test_helper(int rows, int columns, int len, int *wanted, int repeat, void (*func)(grid_t*)) {
    grid_test_ctx_t ctx = {0};
    grid_t grid = {0};
    int *w;

    ctx.len = len;
    
    grid.rows = rows;
    grid.columns = columns;
    grid.adapter.data = &ctx;
    grid.adapter.len = grid_test_ctx_len;

    while (repeat--) {
        w = wanted;
        while (w[0] != -1 && w[1] != -1) {
            func(&grid);
            assert(grid.start == w[0]);
            assert(grid.cur == w[1]);
            w += 2;
        }
    }
}

void grid_layout_test_1() {
    int rows = 3, columns = 3;
    rect_t rects[3 * 3];
    rect_t rect = {0, 0, 30, 30};
    rect_t wanted[9] = {
        {0, 0, 10, 10}, {10, 0, 10, 10}, {20, 0, 10, 10},
        {0, 10, 10, 10}, {10, 10, 10, 10}, {20, 10, 10, 10},
        {0, 20, 10, 10}, {10, 20, 10, 10}, {20, 20, 10, 10},
    };

    grid_t grid = {0};
    grid.rows = rows;
    grid.columns = columns;
    grid.rects = rects;

    grid_layout_test_helper(&grid, &rect, wanted);
}

void grid_down_test() {
    int rows = 3, columns = 3;
    int wanted[][27 * 2] = {
        // 0
        {
            0, 0,
            -1, -1,
        },
        // 1
        {
            0, 0,
            -1, -1,
        },
        // 2
        {
            0, 1,
            0, 0,
            -1, -1,
        },
        // 3
        {
            0, 1,
            0, 2,
            0, 0,
            -1, -1,
        },
        // 4
        {
            0, 3,
            0, 1,
            0, 2,
            0, 0,
            -1, -1,
        },
        // 5
        {
            0, 3,
            0, 1,
            0, 4,
            0, 2,
            0, 0,
            -1, -1,
        },
        // 6
        {
            0, 3,
            0, 1,
            0, 4,
            0, 2,
            0, 5,
            0, 0,
            -1, -1,
        },
        // 7
        {
            0, 3,
            0, 6,
            0, 1,
            0, 4,
            0, 2,
            0, 5,
            0, 0,
            -1, -1,
        },
        // 8
        {
            0, 3,
            0, 6,
            0, 1,
            0, 4,
            0, 7,
            0, 2,
            0, 5,
            0, 0,
            -1, -1,
        },
        // 9
        {
            0, 3,
            0, 6,
            0, 1,
            0, 4,
            0, 7,
            0, 2,
            0, 5,
            0, 8,
            0, 0,
            -1, -1,
        },
        // 10
        {
            0, 3,
            0, 6,
            3, 9,
            0, 1,
            0, 4,
            0, 7,
            0, 2,
            0, 5,
            0, 8,
            0, 0,
            -1, -1,
        },
        // 11
        {
            0, 3,
            0, 6,
            3, 9,
            0, 1,
            0, 4,
            0, 7,
            3, 10,
            0, 2,
            0, 5,
            0, 8,
            0, 0,
            -1, -1,
        },
        // 12
        {
            0, 3,
            0, 6,
            3, 9,
            0, 1,
            0, 4,
            0, 7,
            3, 10,
            0, 2,
            0, 5,
            0, 8,
            3, 11,
            0, 0,
            -1, -1,
        },
        // 13
        {
            0, 3,
            0, 6,
            3, 9,
            6, 12,
            0, 1,
            0, 4,
            0, 7,
            3, 10,
            0, 2,
            0, 5,
            0, 8,
            3, 11,
            0, 0,
            -1, -1,
        },
        // 14
        {-1, -1},
        // 15
        {-1, -1},
        // 16
        {-1, -1},
        // 17
        {-1, -1},
        // 18
        {-1, -1},
        // 19
        {-1, -1},
        // 20
        {
            0, 3,
            0, 6,
            3, 9,
            6, 12,
            9, 15,
            12, 18,
            
            0, 1,
            0, 4,
            0, 7,
            3, 10,
            6, 13,
            9, 16,
            12, 19,

            0, 2,
            0, 5,
            0, 8,
            3, 11,
            6, 14,
            9, 17,

            0, 0,
            -1, -1,
        },
        // 21
    };
    int i;

    for (i = 0; i < ARRAY_SIZE(wanted); i++) {
        grid_nav_test_helper(rows, columns, i, wanted[i], 3, grid_down);
    }
}

void grid_up_test() {
    int rows = 3, columns = 3;
    int wanted[][27 * 2] = {
        // 0
        {
            0, 0,
            -1, -1,
        },
        // 1
        {
            0, 0,
            -1, -1,
        },
        // 2
        {
            0, 1,
            0, 0,
            -1, -1,
        },
        // 3
        {
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 4
        {
            0, 2,
            0, 1,
            0, 3,
            0, 0,
            -1, -1,
        },
        // 5
        {
            0, 2,
            0, 4,
            0, 1,
            0, 3,
            0, 0,
            -1, -1,
        },
        // 6
        {
            0, 5,
            0, 2,
            0, 4,
            0, 1,
            0, 3,
            0, 0,
            -1, -1,
        },
        // 7
        {
            0, 5,
            0, 2,
            0, 4,
            0, 1,
            0, 6,
            0, 3,
            0, 0,
            -1, -1,
        },
        // 8
        {
            0, 5,
            0, 2,
            0, 7,
            0, 4,
            0, 1,
            0, 6,
            0, 3,
            0, 0,
            -1, -1,
        },
        // 9
        {
            0, 8,
            0, 5,
            0, 2,
            0, 7,
            0, 4,
            0, 1,
            0, 6,
            0, 3,
            0, 0,
            -1, -1,
        },
        // 10
        {
            3, 8,
            3, 5,
            0, 2,
            3, 7,
            3, 4,
            0, 1,
            3, 9,
            3, 6,
            3, 3,
            0, 0,
            -1, -1,
        },
        // 11
        {
            3, 8,
            3, 5,
            0, 2,
            3, 10,
            3, 7,
            3, 4,
            0, 1,
            3, 9,
            3, 6,
            3, 3,
            0, 0,
            -1, -1,
        },
        // 12
        {
            3, 11,
            3, 8,
            3, 5,
            0, 2,
            3, 10,
            3, 7,
            3, 4,
            0, 1,
            3, 9,
            3, 6,
            3, 3,
            0, 0,
            -1, -1,
        },
        // 13
        {
            6, 11,
            6, 8,
            3, 5,
            0, 2,
            6, 10,
            6, 7,
            3, 4,
            0, 1,
            6, 12,
            6, 9,
            6, 6,
            3, 3,
            0, 0,
            -1, -1,
        },
        // 14
        {-1, -1},
        // 15
        {-1, -1},
        // 16
        {-1, -1},
        // 17
        {-1, -1},
        // 18
        {-1, -1},
        // 19
        {-1, -1},
        // 20
        {
            12, 17,
            12, 14,
            9, 11,
            6, 8,
            3, 5,
            0, 2,
            
            12, 19,
            12, 16,
            12, 13,
            9, 10,
            6, 7,
            3, 4,
            0, 1,

            12, 18,
            12, 15,
            12, 12,
            9, 9,
            6, 6,
            3, 3,

            0, 0,
            -1, -1,
        },
        // 21
    };
    int i;

    for (i = 0; i < ARRAY_SIZE(wanted); i++) {
        grid_nav_test_helper(rows, columns, i, wanted[i], 3, grid_up);
    }
}

void grid_right_test() {
    int rows = 3, columns = 3;
    int wanted[][27 * 2] = {
        // 0
        {
            0, 0,
            -1, -1,
        },
        // 1
        {
            0, 0,
            -1, -1,
        },
        // 2
        {
            0, 1,
            0, 0,
            -1, -1,
        },
        // 3
        {
            0, 1,
            0, 2,
            0, 0,
            -1, -1,
        },
        // 4
        {
            0, 1,
            0, 2,
            0, 3,
            0, 0,
            -1, -1,
        },
        // 5
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 0,
            -1, -1,
        },
        // 6
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 0,
            -1, -1,
        },
        // 7
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 6,
            0, 0,
            -1, -1,
        },
        // 8
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 6,
            0, 7,
            0, 0,
            -1, -1,
        },
        // 9
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 6,
            0, 7,
            0, 8,
            0, 0,
            -1, -1,
        },
        // 10
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 6,
            0, 7,
            0, 8,
            3, 9,
            0, 0,
            -1, -1,
        },
        // 11
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 6,
            0, 7,
            0, 8,
            3, 9,
            3, 10,
            0, 0,
            -1, -1,
        },
        // 12
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 6,
            0, 7,
            0, 8,
            3, 9,
            3, 10,
            3, 11,
            0, 0,
            -1, -1,
        },
        // 13
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 6,
            0, 7,
            0, 8,
            3, 9,
            3, 10,
            3, 11,
            6, 12,
            0, 0,
            -1, -1,
        },
        // 14
        {-1, -1},
        // 15
        {-1, -1},
        // 16
        {-1, -1},
        // 17
        {-1, -1},
        // 18
        {-1, -1},
        // 19
        {-1, -1},
        // 20
        {
            0, 1,
            0, 2,
            0, 3,
            0, 4,
            0, 5,
            0, 6,
            0, 7,
            0, 8,
            
            3, 9,
            3, 10,
            3, 11,

            6, 12,
            6, 13,
            6, 14,

            9, 15,
            9, 16,
            9, 17,

            12, 18,
            12, 19,

            0, 0,

            -1, -1,
        },
        // 21
    };
    int i;

    for (i = 0; i < ARRAY_SIZE(wanted); i++) {
        grid_nav_test_helper(rows, columns, i, wanted[i], 3, grid_right);
    }
}

void grid_left_test() {
    int rows = 3, columns = 3;
    int wanted[][27 * 2] = {
        // 0
        {
            0, 0,
            -1, -1,
        },
        // 1
        {
            0, 0,
            -1, -1,
        },
        // 2
        {
            0, 1,
            0, 0,
            -1, -1,
        },
        // 3
        {
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 4
        {
            0, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 5
        {
            0, 4,
            0, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 6
        {
            0, 5,
            0, 4,
            0, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 7
        {
            0, 6,
            0, 5,
            0, 4,
            0, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 8
        {
            0, 7,
            0, 6,
            0, 5,
            0, 4,
            0, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 9
        {
            0, 8,
            0, 7,
            0, 6,
            0, 5,
            0, 4,
            0, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 10
        {
            3, 9,
            3, 8,
            3, 7,
            3, 6,
            3, 5,
            3, 4,
            3, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 11
        {
            3, 10,
            3, 9,
            3, 8,
            3, 7,
            3, 6,
            3, 5,
            3, 4,
            3, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 12
        {
            3, 11,
            3, 10,
            3, 9,
            3, 8,
            3, 7,
            3, 6,
            3, 5,
            3, 4,
            3, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 13
        {
            6, 12,
            6, 11,
            6, 10,
            6, 9,
            6, 8,
            6, 7,
            6, 6,
            3, 5,
            3, 4,
            3, 3,
            0, 2,
            0, 1,
            0, 0,
            -1, -1,
        },
        // 14
        {-1, -1},
        // 15
        {-1, -1},
        // 16
        {-1, -1},
        // 17
        {-1, -1},
        // 18
        {-1, -1},
        // 19
        {-1, -1},
        // 20
        {
            12, 19,
            12, 18,
            
            12, 17,
            12, 16,
            12, 15,

            12, 14,
            12, 13,
            12, 12,

            9, 11,
            9, 10,
            9, 9,

            6, 8,
            6, 7,
            6, 6,

            3, 5,
            3, 4,
            3, 3,

            0, 2,
            0, 1,
            0, 0,

            -1, -1,
        },
        // 21
    };
    int i;

    for (i = 0; i < ARRAY_SIZE(wanted); i++) {
        grid_nav_test_helper(rows, columns, i, wanted[i], 3, grid_left);
    }
}

void grid_test() {
    grid_layout_test_1();
    grid_down_test();
    grid_up_test();
    grid_right_test();
    grid_left_test();
}
