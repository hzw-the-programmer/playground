#include <stdint.h>
#include "picotls.h"
#include "picotls/minicrypto.h"

int handshake_test_2() {
	uint8_t server_hello[] = {
		// record header
		0x16, // PTLS_CONTENT_TYPE_HANDSHAKE
		0x03, 0x03, // PTLS_PROTOCOL_VERSION_TLS12
		0x00, 0x7b, // len

		// msg header
		0x02, // PTLS_HANDSHAKE_TYPE_SERVER_HELLO
		0x00, 0x00, 0x77, // len

		// legacy_version
		0x03, 0x03, // PTLS_PROTOCOL_VERSION_TLS12

		// random_bytes
		0xab, 0x7c, 0x9f, 0xc2, 0x00, 0x20, 0x98, 0x35, 0xcc, 0xee,
		0xa0, 0x3f, 0x80, 0x33, 0x3a, 0x21, 0xc0, 0x51, 0x6b, 0x7c,
		0xa4, 0xda, 0xda, 0x70, 0x05, 0xe3, 0x22, 0xf9, 0xce, 0xc2,
		0x0e, 0xa2,

		// lecagy_session_id
		0x00, // len

		// cipher_suite
		0x13, 0x02, // PTLS_CIPHER_SUITE_AES_256_GCM_SHA384

		0x00,

		// extensions
		0x00, 0x4f, // len

		// PTLS_EXTENSION_TYPE_SUPPORTED_VERSIONS
		0x00, 0x2b,
		0x00, 0x02, // len
		0x03, 0x04, // PTLS_PROTOCOL_VERSION_TLS13

		// PTLS_EXTENSION_TYPE_KEY_SHARE
		0x00, 0x33,
		0x00, 0x45, // len
		0x00, 0x17, // PTLS_GROUP_SECP256R1
		0x00, 0x41, // len
		0x04, // TYPE_UNCOMPRESSED_PUBLIC_KEY
		0x81, 0xb6, 0x45, 0x65, 0x40, 0xf8, 0x87, 0x8d, 0x78, 0x7c,
		0xbe, 0x3d, 0x67, 0x4f, 0x40, 0xd8, 0x3a, 0x73, 0x6e, 0x5b,
		0x45, 0xda, 0xd2, 0xd6, 0x3e, 0x8e, 0x79, 0x7a, 0xa2, 0x3f,
		0xbf, 0x03, 0xec, 0x17, 0xcc, 0x64, 0x68, 0xf6, 0x34, 0x8c,
		0x78, 0x2f, 0x8e, 0x41, 0x2d, 0x23, 0x3e, 0x18, 0xa8, 0x96,
		0x9c, 0x9c, 0x94, 0x31, 0x6e, 0x7a, 0x07, 0xc1, 0x9a, 0x29,
		0x07, 0x32, 0xcf, 0x8d,
	};
	uint8_t change_cipher_spec[] = {
		// record header
		0x14, // PTLS_CONTENT_TYPE_CHANGE_CIPHER_SPEC
		0x03, 0x03, // PTLS_PROTOCOL_VERSION_TLS12
		0x00, 0x01, // len
		
		// msg
		0x01,
	};
	uint8_t appdata_1[] = {
		// record header
		0x17, // PTLS_CONTENT_TYPE_APPDATA
		0x03, 0x03, // PTLS_PROTOCOL_VERSION_TLS12
		0x00, 0x17, // len

		// msg
		0x8e, 0x97, 0xc3, 0x1e, 0x49, 0x0e, 0xad, 0x69, 0x7a, 0x46,
		0xed, 0xac, 0xc7, 0x4a, 0x19, 0x61, 0x6d, 0xe5, 0x50, 0x78,
		0x6b, 0x84, 0xd9,
	};

	ptls_context_t ctx = { 0 };
	ctx.get_time = &ptls_get_time;
	ctx.random_bytes = ptls_minicrypto_random_bytes;
	ctx.key_exchanges = ptls_minicrypto_key_exchanges;
	ctx.cipher_suites = ptls_minicrypto_cipher_suites;

	ptls_t* tls = ptls_client_new(&ctx);

	int ret;

	ptls_buffer_t send_buf;
	ptls_buffer_init(&send_buf, "", 0);
	ret = ptls_handshake(tls, &send_buf, NULL, 0, NULL);

	send_buf.off = 0;
	for (size_t i = 0; i < sizeof(server_hello); i++) {
		size_t inlen = 1;
		ret = ptls_handshake(tls, &send_buf, server_hello + i, &inlen, NULL);
	}
	for (size_t i = 0; i < sizeof(change_cipher_spec); i++) {
		size_t inlen = 1;
		ret = ptls_handshake(tls, &send_buf, change_cipher_spec + i, &inlen, NULL);
	}
	for (size_t i = 0; i < sizeof(appdata_1); i++) {
		size_t inlen = 1;
		ret = ptls_handshake(tls, &send_buf, appdata_1 + i, &inlen, NULL);
	}
	return 0;
}